name: Deploy Module to ACR

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Module version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      force_publish:
        description: 'Force publish even if version exists'
        required: false
        type: boolean

env:
  ACR_NAME: msftlabsbicepmods
  ACR_LOGIN_SERVER: msftlabsbicepmods.azurecr.io
  MODULE_NAME: storageaccount
  MODULE_PATH: bicep/modules
  SUBSCRIPTION_ID: b18ea7d6-14b5-41f3-a00d-804a5180c589

permissions:
  contents: write  # Required for creating GitHub releases

jobs:
  validate:
    name: Validate Before Publish
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Determine Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Publishing version: $VERSION"
      
      - name: Validate Version Format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! [[ $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid version format: $VERSION"
            echo "Version must follow semantic versioning (e.g., 1.0.0)"
            exit 1
          fi
          echo "Version format valid: $VERSION"
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'
      
      - name: Validate Bicep Module
        run: |
          echo "Validating Bicep syntax..."
          az bicep build --file main.bicep
          
          if [ ! -f main.json ]; then
            echo "Build failed: main.json not generated"
            exit 1
          fi
          
          echo "Bicep validation successful"
      
      - name: Check if Version Exists
        id: check_version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Check if tag exists in ACR
          TAGS=$(az acr repository show-tags \
            --name ${{ env.ACR_NAME }} \
            --repository ${{ env.MODULE_PATH }}/${{ env.MODULE_NAME }} \
            --output tsv 2>/dev/null || echo "")
          
          if echo "$TAGS" | grep -q "^${VERSION}$"; then
            echo "version_exists=true" >> $GITHUB_OUTPUT
            echo "Version $VERSION already exists in ACR"
          else
            echo "version_exists=false" >> $GITHUB_OUTPUT
            echo "Version $VERSION is new"
          fi
      
      - name: Validate Version Uniqueness
        if: steps.check_version.outputs.version_exists == 'true' && github.event.inputs.force_publish != 'true'
        run: |
          echo "Version ${{ steps.version.outputs.version }} already exists in ACR"
          echo "Use force_publish option or create a new version"
          exit 1

  publish:
    name: Publish to ACR
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'
      
      - name: Set Azure Subscription
        run: |
          az account set --subscription ${{ env.SUBSCRIPTION_ID }}
      
      - name: Login to Azure Container Registry
        run: |
          az acr login --name ${{ env.ACR_NAME }}
      
      - name: Publish Module to ACR (Versioned)
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          TARGET="br:${{ env.ACR_LOGIN_SERVER }}/${{ env.MODULE_PATH }}/${{ env.MODULE_NAME }}:${VERSION}"
          
          echo "Publishing to: $TARGET"
          
          az bicep publish \
            --file main.bicep \
            --target "$TARGET" \
            ${{ github.event.inputs.force_publish == 'true' && '--force' || '' }}
          
          echo "Successfully published version $VERSION"
      
      - name: Publish Latest Tag
        run: |
          TARGET="br:${{ env.ACR_LOGIN_SERVER }}/${{ env.MODULE_PATH }}/${{ env.MODULE_NAME }}:latest"
          
          echo "Publishing latest tag to: $TARGET"
          
          az bicep publish \
            --file main.bicep \
            --target "$TARGET" \
            --force
          
          echo "Successfully published latest tag"
      
      - name: Verify Publication
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          
          echo "Verifying published module..."
          
          TAGS=$(az acr repository show-tags \
            --name ${{ env.ACR_NAME }} \
            --repository ${{ env.MODULE_PATH }}/${{ env.MODULE_NAME }} \
            --output table)
          
          echo "Available tags:"
          echo "$TAGS"
          
          if echo "$TAGS" | grep -q "$VERSION"; then
            echo "Version $VERSION successfully verified in ACR"
          else
            echo "Failed to verify version $VERSION in ACR"
            exit 1
          fi
      
      - name: Generate Deployment Summary
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          MODULE_REF="br:${{ env.ACR_LOGIN_SERVER }}/${{ env.MODULE_PATH }}/${{ env.MODULE_NAME }}:${VERSION}"
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ### Module Published Successfully
          
          **Module:** ${{ env.MODULE_NAME }}
          **Version:** ${VERSION}
          **Registry:** ${{ env.ACR_LOGIN_SERVER }}
          **Published:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          **Module Reference:**
          \`\`\`bicep
          module storage '${MODULE_REF}' = {
            name: 'storageAccountDeployment'
            params: {
              storageAccountName: 'mystorageaccount'
              tags: {
                Environment: 'Production'
              }
            }
          }
          \`\`\`
          
          **Using Alias (with bicepconfig.json):**
          \`\`\`bicep
          module storage 'br/msftlabsbicepmods:${{ env.MODULE_NAME }}:${VERSION}' = {
            name: 'storageAccountDeployment'
            params: {
              storageAccountName: 'mystorageaccount'
              tags: {
                Environment: 'Production'
              }
            }
          }
          \`\`\`
          EOF
      
      - name: Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          TAG_NAME="v${VERSION}"
          MODULE_REF="br:${{ env.ACR_LOGIN_SERVER }}/${{ env.MODULE_PATH }}/${{ env.MODULE_NAME }}:${VERSION}"
          
          # Create release notes in a file to avoid shell escaping issues
          cat > release_notes.md << 'RELEASE_NOTES'
          **Storage Account Bicep Module v${{ needs.validate.outputs.version }}**
          
          **Published to:** `${{ env.ACR_LOGIN_SERVER }}/${{ env.MODULE_PATH }}/${{ env.MODULE_NAME }}:${{ needs.validate.outputs.version }}`
          
          **Usage:**
          ```bicep
          module storage 'br:${{ env.ACR_LOGIN_SERVER }}/${{ env.MODULE_PATH }}/${{ env.MODULE_NAME }}:${{ needs.validate.outputs.version }}' = {
            name: 'storageAccountDeployment'
            params: {
              workloadName: 'myapp'
              location: 'eastus'
            }
          }
          ```
          
          See [CHANGELOG.md](CHANGELOG.md) for details.
          RELEASE_NOTES
          
          # Create release using GitHub CLI
          gh release create "$TAG_NAME" \
            --title "Release ${VERSION}" \
            --notes-file release_notes.md \
            --repo ${{ github.repository }}
          
          echo "Release created successfully for ${TAG_NAME}"
          rm release_notes.md

