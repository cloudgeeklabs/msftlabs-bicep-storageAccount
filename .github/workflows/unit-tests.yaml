name: Unit Tests (Pester)

on:
  push:
    branches:
      - main
      - develop
    paths:
      - '**.bicep'
      - 'tests/**'
      - '.github/workflows/unit-tests.yaml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**.bicep'
      - 'tests/**'
  workflow_dispatch:

jobs:
  pester-tests:
    name: Run Pester Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Pester
        shell: pwsh
        run: |
          Install-Module -Name Pester -Force -SkipPublisherCheck -MinimumVersion 5.0.0
          Import-Module Pester -MinimumVersion 5.0.0
          Get-Module Pester
      
      - name: Update Test Parameters
        shell: pwsh
        run: |
          $parametersFile = "tests/test.parameters.json"
          $parameters = Get-Content $parametersFile | ConvertFrom-Json
          
          # Generate unique storage account name
          $uniqueName = "ghtest${{ github.run_number }}"
          $parameters.parameters.storageAccountName.value = $uniqueName
          
          $parameters | ConvertTo-Json -Depth 10 | Set-Content $parametersFile
          
          Write-Host "Updated storage account name to: $uniqueName"
      
      - name: Run Pester Tests
        shell: pwsh
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = './tests'
          $config.Run.Exit = $false  # Don't exit immediately to allow output to flush
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = './test-results.xml'
          $config.TestResult.OutputFormat = 'NUnitXml'
          $config.Output.Verbosity = 'Detailed'
          
          $result = Invoke-Pester -Configuration $config
          
          # Explicitly output test summary
          Write-Host "`n========================================" -ForegroundColor Cyan
          Write-Host "PESTER TEST SUMMARY" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Total Tests: $($result.TotalCount)" -ForegroundColor White
          Write-Host "Passed: $($result.PassedCount)" -ForegroundColor Green
          Write-Host "Failed: $($result.FailedCount)" -ForegroundColor $(if ($result.FailedCount -gt 0) { 'Red' } else { 'Green' })
          Write-Host "Skipped: $($result.SkippedCount)" -ForegroundColor Yellow
          Write-Host "========================================`n" -ForegroundColor Cyan
          
          # Exit with non-zero if tests failed
          if ($result.FailedCount -gt 0) {
            exit 1
          }
      
      - name: Test Summary
        if: always()
        shell: pwsh
        run: |
          if (Test-Path test-results.xml) {
            [xml]$testResults = Get-Content test-results.xml
            $totalTests = $testResults.'test-results'.'total'
            $failures = $testResults.'test-results'.'failures'
            $errors = $testResults.'test-results'.'errors'
            $passed = [int]$totalTests - [int]$failures - [int]$errors
            
            $summary = @"
          ### Pester Test Results
          
          **Total Tests:** $totalTests
          **Passed:** $passed
          **Failed:** $failures
          **Errors:** $errors
          **Status:** $(if ([int]$failures -eq 0 -and [int]$errors -eq 0) { 'PASSED' } else { 'FAILED' })
          "@
            
            $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          }
