name: Unit Tests (Pester)

on:
  push:
    branches:
      - main
      - develop
    paths:
      - '**.bicep'
      - 'tests/**'
      - '.github/workflows/unit-tests.yaml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**.bicep'
      - 'tests/**'
  workflow_dispatch:

jobs:
  pester-tests:
    name: Run Pester Tests
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install Bicep CLI
        shell: pwsh
        run: |
          az bicep install
          az bicep version

      - name: Install Pester
        shell: pwsh
        run: |
          Install-Module -Name Pester -Force -SkipPublisherCheck -MinimumVersion 5.0.0
          Import-Module Pester -MinimumVersion 5.0.0
          Get-Module Pester
      
      - name: Update Test Parameters
        shell: pwsh
        run: |
          $parametersFile = "tests/test.parameters.json"
          $parameters = Get-Content $parametersFile | ConvertFrom-Json
          
          # Generate unique storage account name
          $uniqueName = "ghtest${{ github.run_number }}"
          $parameters.parameters.storageAccountName.value = $uniqueName
          
          $parameters | ConvertTo-Json -Depth 10 | Set-Content $parametersFile
          
          Write-Host "Updated storage account name to: $uniqueName"
      
      - name: Run Pester Tests
        shell: pwsh
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = './tests'
          $config.Run.Exit = $false
          $config.Run.PassThru = $true  # Required to return result object
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = './test-results.xml'
          $config.TestResult.OutputFormat = 'NUnitXml'
          $config.Output.Verbosity = 'Detailed'
          $config.Output.CIFormat = 'GithubActions'
          
          Write-Host "Starting Pester tests..." -ForegroundColor Cyan
          $result = Invoke-Pester -Configuration $config
          
          # Force output buffer flush
          [Console]::Out.Flush()
          
          # Explicitly output test summary
          Write-Host "`n========================================" -ForegroundColor Cyan
          Write-Host "PESTER TEST SUMMARY" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Total Tests: $($result.TotalCount)" -ForegroundColor White
          Write-Host "Passed: $($result.PassedCount)" -ForegroundColor Green
          Write-Host "Failed: $($result.FailedCount)" -ForegroundColor $(if ($result.FailedCount -gt 0) { 'Red' } else { 'Green' })
          Write-Host "Skipped: $($result.SkippedCount)" -ForegroundColor Yellow
          Write-Host "Duration: $($result.Duration)" -ForegroundColor Gray
          Write-Host "========================================`n" -ForegroundColor Cyan
          
          # Exit with non-zero if tests failed
          if ($result.FailedCount -gt 0) {
            Write-Host "Tests FAILED" -ForegroundColor Red
            exit 1
          } else {
            Write-Host "All tests PASSED" -ForegroundColor Green
          }
      
      - name: Test Summary
        if: always()
        shell: pwsh
        run: |
          if (Test-Path test-results.xml) {
            Write-Host "Parsing test results..." -ForegroundColor Cyan
            
            [xml]$testResults = Get-Content test-results.xml
            
            # NUnitXml format uses 'test-results' as root element
            $rootElement = $testResults.'test-results'
            
            if ($rootElement) {
              $totalTests = $rootElement.total
              $failures = $rootElement.failures
              $errors = $rootElement.errors
              $notRun = $rootElement.'not-run'
              $inconclusive = $rootElement.inconclusive
              $ignored = $rootElement.ignored
              $skipped = $rootElement.skipped
              $invalid = $rootElement.invalid
              
              $passed = [int]$totalTests - [int]$failures - [int]$errors - [int]$notRun - [int]$inconclusive - [int]$ignored - [int]$skipped - [int]$invalid
              
              Write-Host "Total: $totalTests, Passed: $passed, Failed: $failures, Errors: $errors" -ForegroundColor White
              
              $summary = @"
          ### Pester Test Results
          
          | Metric | Count |
          |--------|-------|
          | **Total Tests** | $totalTests |
          | **Passed** | $passed |
          | **Failed** | $failures |
          | **Errors** | $errors |
          | **Skipped** | $skipped |
          | **Status** | $(if ([int]$failures -eq 0 -and [int]$errors -eq 0) { 'PASSED' } else { 'FAILED' }) |
          "@
              
              Write-Host "Writing summary to GITHUB_STEP_SUMMARY..."
              $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
              Write-Host "Summary written successfully" -ForegroundColor Green
            } else {
              Write-Host "ERROR: Could not parse test-results root element" -ForegroundColor Red
              Get-Content test-results.xml | Select-Object -First 20
            }
          } else {
            Write-Host "ERROR: test-results.xml file not found" -ForegroundColor Red
          }
